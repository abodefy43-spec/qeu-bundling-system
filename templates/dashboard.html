{% extends "layout.html" %}
{% block content %}

  <section class="panel">
    <h2>What I Built (Simple Overview)</h2>
    <p>
      I built this system to automatically suggest strong product bundles from real order behavior, then show the best options in a simple dashboard.
      The pipeline first selects compatible product pairs, then trains ML models to predict which item should be free and how much discount to apply.
      After that, it generates the final ranked bundle files and updates this Flask page so the newest results are visible right away.
    </p>
    <p style="margin: 10px 0 0; color: var(--muted);">
      To make refreshing easier, I connected the quick run flow to launch both the new results pipeline and the presentation together, so one run updates everything in one place.
    </p>
  </section>

  <!-- KPI Section -->
  <section class="panel">
    <div class="panel-header">
      <h2>Performance Snapshot</h2>
      <form method="post" action="{{ url_for('refresh') }}">
        <button type="submit" class="btn" {% if run_status.running %}disabled{% endif %}>
          {% if run_status.running %}Refresh Runningâ€¦{% else %}Refresh Data{% endif %}
        </button>
      </form>
    </div>
    <div class="kpi-grid">
      <article class="kpi-card kpi-card--blue">
        <div class="kpi-icon">ðŸ“¦</div>
        <p class="kpi-label">Total Bundles</p>
        <p class="kpi-value">{{ kpis.total_bundles }}</p>
      </article>
      <article class="kpi-card kpi-card--orange">
        <div class="kpi-icon">ðŸ’°</div>
        <p class="kpi-label">Average Discount</p>
        <p class="kpi-value">{{ kpis.avg_discount }}</p>
      </article>
      <article class="kpi-card kpi-card--green">
        <div class="kpi-icon">ðŸŒ™</div>
        <p class="kpi-label">Ramadan-Relevant</p>
        <p class="kpi-value">{{ kpis.ramadan_pct }}</p>
      </article>
      <article class="kpi-card kpi-card--purple">
        <div class="kpi-icon">ðŸ”—</div>
        <p class="kpi-label">3-Item Bundles</p>
        <p class="kpi-value">{{ kpis.triple_bundles }}</p>
      </article>
    </div>
    <p style="margin:10px 0 0; color: var(--muted); font-size:0.82rem;">Last updated: {{ kpis.last_output_update }}</p>
  </section>

  <!-- Top 10 Bundle Cards -->
  <section class="panel">
    <h2>Top 10 Compatible Bundles</h2>
    {% if data_warning %}
      <p class="empty">{{ data_warning }}</p>
    {% elif top10_rows %}
      <div class="bundle-grid">
        {% for row in top10_rows %}
          <div class="bundle-card">
            <div class="bundle-card__rank">
              Bundle #{{ loop.index }}
              {% if row.is_triple %}<span class="badge badge--triple">3-Item</span>{% endif %}
              {% if row.has_ramadan %}<span class="badge badge--ramadan">Ramadan</span>{% endif %}
            </div>

            {# Items: paid first, free last #}
            {% for item in row.bundle_items %}
            <div class="bundle-card__item">
              <div class="bundle-card__product-thumb">
                {% if item.image_url %}
                  <img src="{{ item.image_url }}" alt="{{ item.name }}" loading="lazy">
                {% else %}
                  <svg class="bundle-card__product-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                {% endif %}
              </div>
              <span class="bundle-card__name" title="{{ item.name }}">{{ item.name }}</span>
              <div class="bundle-card__prices">
                <span class="price-product-name" title="{{ item.name }}">{{ item.name }}</span>
                {% if item.is_free %}
                  <span class="price-original--struck">SAR {{ item.price_sar }}</span>
                  <span class="badge badge--free">FREE</span>
                {% else %}
                  <div class="price-row">
                    <span class="price-original--struck">SAR {{ item.price_sar }}</span>
                    <span class="price-after">SAR {{ item.price_after_sar }}</span>
                  </div>
                  <span class="badge badge--discount badge--below">{{ item.discount }} OFF</span>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="empty">No bundles available yet. Run a refresh to generate data.</p>
    {% endif %}
  </section>

  <!-- Person-level Recommendation Examples -->
  <section class="panel">
    <h2>Personalized Recommendations</h2>
    {% if person_recommendations %}
      <p class="people-reco__intro">
        Based on purchase history across multiple orders. Each recommendation blends shopper history + bundle quality + copurchase behavior.
      </p>
      <div class="people-reco-grid">
        {% for reco in person_recommendations %}
        <div class="bundle-card people-reco-card">
          <div class="people-reco-card__header">
            <span class="people-reco-card__person">{{ reco.person_label }}</span>
            <span class="badge badge--orders">{{ reco.order_count }} orders</span>
            <span class="badge badge--ramadan">{{ reco.history_match_count }} matched</span>
          </div>
          <p class="people-reco-card__history-label">Purchase history ({{ reco.history_items | length }} products):</p>
          <p class="people-reco-card__history">
            <strong>{{ reco.history_items | join(", ") }}</strong>
          </p>
          <p class="people-reco-card__meta">
            Recommended bundle:
            <strong>{{ reco.chosen_bundle_names | join(" + ") }}</strong>
          </p>
          <p class="people-reco-card__free">
            Free item:
            <strong>
              {% if reco.free_product == "product_a" %}
                {{ reco.product_a_name }}
              {% elif reco.free_product == "product_b" %}
                {{ reco.product_b_name }}
              {% elif reco.free_product == "product_c" %}
                {{ reco.product_c_name }}
              {% else %}
                {{ reco.product_b_name }}
              {% endif %}
            </strong>
          </p>
          {% for item in reco.bundle_items %}
          <div class="bundle-card__item">
            <div class="bundle-card__product-thumb">
              {% if item.image_url %}
                <img src="{{ item.image_url }}" alt="{{ item.name }}" loading="lazy">
              {% else %}
                <svg class="bundle-card__product-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
              {% endif %}
            </div>
            <span class="bundle-card__name" title="{{ item.name }}">{{ item.name }}</span>
            <div class="bundle-card__prices">
              <span class="price-product-name" title="{{ item.name }}">{{ item.name }}</span>
              {% if item.is_free %}
                <span class="price-original--struck">SAR {{ item.price_sar }}</span>
                <span class="badge badge--free">FREE</span>
              {% else %}
                <div class="price-row">
                  <span class="price-original--struck">SAR {{ item.price_sar }}</span>
                  <span class="price-after">SAR {{ item.price_after_sar }}</span>
                </div>
                <span class="badge badge--discount badge--below">{{ item.discount }} OFF</span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="empty">No person-level history sample available yet.</p>
    {% endif %}
  </section>

  <!-- Refresh Status -->
  <section class="panel">
    <h2>Refresh Status</h2>
    <p><strong>Running:</strong> {{ "Yes" if run_status.running else "No" }}</p>
    <p><strong>Started (UTC):</strong> {{ run_status.last_started_utc or "N/A" }}</p>
    <p><strong>Finished (UTC):</strong> {{ run_status.last_finished_utc or "N/A" }}</p>
    <p><strong>Exit Code:</strong> {{ run_status.last_exit_code if run_status.last_exit_code is not none else "N/A" }}</p>
    {% if run_status.last_error %}
      <p class="error"><strong>Last Error:</strong> {{ run_status.last_error }}</p>
    {% endif %}
    {% if run_status.log_tail %}
      <details>
        <summary>Recent Pipeline Log</summary>
        <pre class="logbox">{% for line in run_status.log_tail %}{{ line }}
{% endfor %}</pre>
      </details>
    {% endif %}
  </section>

{% endblock %}
